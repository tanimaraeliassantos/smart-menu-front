<div class="barra-page">
  <header class="barra-header">
    <h1 class="titulo">Barra / Cocina</h1>
    @if (cargando) {
      <small class="status-sync" role="status">Sincronizando...</small>
    }
  </header>

  <main class="barra-columnas">
    <section class="kanban-col" aria-labelledby="header-nuevos">
      <h2 id="header-nuevos" class="col-header">Nuevos Pedidos</h2>
      <div class="lista-pedidos">
        @for (mesa of getMesasEnEstado('NUEVO'); track mesa) {
          <div class="mesa-group">
            <span class="mesa-badge">Mesa {{ mesa }}</span>
            @for (p of getPedidosDeMesaEnEstado(mesa, 'NUEVO'); track p.id) {
              <ng-container *ngTemplateOutlet="ticket; context: { $implicit: p }"></ng-container>
            }
          </div>
        } @empty {
          <div class="vacio-msg">Sin pedidos</div>
        }
      </div>
    </section>

    <section class="kanban-col" aria-labelledby="header-preparando">
      <h2 id="header-preparando" class="col-header">Preparando</h2>
      <div class="lista-pedidos">
        @for (mesa of getMesasEnEstado('EN_PREPARACION'); track mesa) {
          <div class="mesa-group">
            <span class="mesa-badge">Mesa {{ mesa }}</span>
            @for (p of getPedidosDeMesaEnEstado(mesa, 'EN_PREPARACION'); track p.id) {
              <ng-container *ngTemplateOutlet="ticket; context: { $implicit: p }"></ng-container>
            }
          </div>
        } @empty {
          <div class="vacio-msg">Libre</div>
        }
      </div>
    </section>

    <section class="kanban-col" aria-labelledby="header-listos">
      <h2 id="header-listos" class="col-header">Listos</h2>
      <div class="lista-pedidos">
        @for (mesa of getMesasEnEstado('LISTO'); track mesa) {
          <div class="mesa-group">
            <span class="mesa-badge">Mesa {{ mesa }}</span>
            @for (p of getPedidosDeMesaEnEstado(mesa, 'LISTO'); track p.id) {
              <ng-container *ngTemplateOutlet="ticket; context: { $implicit: p }"></ng-container>
            }
          </div>
        } @empty {
          <div class="vacio-msg">Vacío</div>
        }
      </div>
    </section>

    <section class="kanban-col" aria-labelledby="header-entregados">
      <h2 id="header-entregados" class="col-header">Entregados</h2>
      <div class="lista-pedidos">
        @for (mesa of getMesasEnEstado('ENTREGADO'); track mesa) {
          <div class="mesa-group">
            <span class="mesa-badge">Mesa {{ mesa }}</span>
            @for (p of getPedidosDeMesaEnEstado(mesa, 'ENTREGADO'); track p.id) {
              <ng-container *ngTemplateOutlet="ticket; context: { $implicit: p }"></ng-container>
            }
          </div>
        } @empty {
          <div class="vacio-msg">Vacío</div>
        }
      </div>
    </section>
  </main>
</div>

<ng-template #ticket let-p>
  <article class="tarjeta-pedido">
    <section class="tarjeta-items">
      @for (item of p.items; track $index) {
        <div class="item-linea">
          <strong class="item-cantidad">{{ item.cantidad }}x</strong>
          <span class="item-nombre">{{ item.nombreActual }}</span>
          @if (item.nota) {
            <div class="nota-item">Nota: {{ item.nota }}</div>
          }
        </div>
      }
    </section>

    <footer class="acciones-grid">
      @if (puedePasarAEnPreparacion(p)) {
        <button type="button" class="btn-accion" (click)="actualizarEstado(p, 'EN_PREPARACION')">
          Preparar
        </button>
      }
      @if (puedePasarAListo(p)) {
        <button type="button" class="btn-accion" (click)="actualizarEstado(p, 'LISTO')">
          Listo
        </button>
      }
      @if (puedePasarAEntregado(p)) {
        <button type="button" class="btn-accion" (click)="actualizarEstado(p, 'ENTREGADO')">
          Entregar
        </button>
      }
      @if (puedeCancelar(p)) {
        <button
          type="button"
          class="btn-accion btn-cancelar"
          (click)="actualizarEstado(p, 'CANCELADO')"
          aria-label="Cancelar pedido"
        >
          ✖
        </button>
      }
    </footer>
  </article>
</ng-template>
