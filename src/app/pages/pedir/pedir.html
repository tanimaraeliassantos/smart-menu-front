<div class="pedido">
  <header class="top">
    <div class="top-row">
      <div class="title">Confirmar Pedido</div>
      @if (items.length > 0 || pedidoConfirmado) {
        <div class="badge-app" style="background: var(--surface-2); color: var(--accent)">
          üìç {{ mesa }}
        </div>
      }
    </div>
    @if (pedidoConfirmado) {
      <div
        class="status-tracker card-app"
        style="margin-top: 15px; border: 1px solid var(--accent)"
      >
        <div
          class="status-header"
          style="display: flex; justify-content: space-between; margin-bottom: 8px"
        >
          <span style="font-size: 0.85rem; font-weight: 700; color: var(--accent)">
            ESTADO: {{ textoEstadoBonito(estadoActual) }}
          </span>
          <span style="font-size: 0.85rem; color: var(--muted)"
            >{{ getProgresoPorcentaje() }}%</span
          >
        </div>
        <div
          class="progress-bar-bg"
          style="height: 6px; background: var(--surface-2); border-radius: 10px; overflow: hidden"
        >
          <div
            class="progress-fill"
            [style.width.%]="getProgresoPorcentaje()"
            style="height: 100%; background: var(--accent); transition: width 0.8s ease"
          ></div>
        </div>
      </div>
    }
  </header>

  <main class="lista-pedido">
    @if (tieneItemsEnviados()) {
      <div class="separador-comanda" style="color: #2ecc71">EN COCINA (Confirmado)</div>
      @for (item of itemsEnviados(); track identificadorItem($index, item)) {
        <div class="linea card-app enviado" style="opacity: 0.7; border-left: 4px solid #2ecc71">
          <div class="linea-info-principal">
            <div class="nombre">{{ item.nombreActual }} (x{{ item.cantidad }})</div>
            <div class="subtotal">{{ item.cantidad * item.precioActual | number: '1.2-2' }}‚Ç¨</div>
          </div>
          @if (item.nota) {
            <div class="nota-fija" style="font-size: 0.8rem; color: gray italic">
              "{{ item.nota }}"
            </div>
          }
        </div>
      }
    }

    @if (tieneItemsNuevos()) {
      <div class="separador-comanda" style="color: var(--accent); margin-top: 20px">
        A PEDIR (Nueva Ronda)
      </div>
      @for (item of itemsNuevos(); track identificadorItem($index, item)) {
        <div class="linea card-app" style="border-left: 4px solid var(--accent)">
          <div class="linea-info-principal">
            <div class="nombre">{{ item.nombreActual }}</div>
            <div class="subtotal">{{ item.cantidad * item.precioActual | number: '1.2-2' }}‚Ç¨</div>
          </div>

          <div class="linea-controles">
            <button class="btn-cantidad" (click)="cambiarCantidad(item, -1)" [disabled]="enviando">
              ‚àí
            </button>
            <span class="cantidad">{{ item.cantidad }}</span>
            <button class="btn-cantidad" (click)="cambiarCantidad(item, 1)" [disabled]="enviando">
              +
            </button>
          </div>

          <textarea
            class="input-app"
            [(ngModel)]="item.nota"
            (ngModelChange)="cambiarNota(item, $event)"
            [disabled]="enviando"
            placeholder="Nota para cocina..."
          ></textarea>
        </div>
      }
    }
  </main>

  @if (items.length > 0) {
    <footer class="pie card-app" style="margin-top: auto">
      <div class="totales">
        <span style="color: var(--muted)">Total Pedido:</span>
        <span class="total-euros" style="color: var(--accent)"
          >{{ totalEuros | number: '1.2-2' }} ‚Ç¨</span
        >
      </div>

      <div class="acciones">
        <button class="btn-app danger" (click)="vaciarCarrito()">Vaciar</button>
        <button class="btn-app secondary" (click)="volverAlMenu()">A√±adir m√°s</button>
        <button
          class="btn-app primary"
          [disabled]="enviando || !tieneItemsNuevos()"
          (click)="confirmarPedido()"
        >
          {{ enviando ? 'Enviando...' : 'Confirmar Nueva Ronda' }}
        </button>
      </div>
    </footer>
  } @else if (pedidoConfirmado) {
    <footer class="pie card-app" style="margin-top: auto; text-align: center; padding: 20px">
      <p style="color: var(--muted); margin-bottom: 10px">¬øTe apetece algo m√°s?</p>
      <button class="btn-app secondary" (click)="volverAlMenu()">A√±adir m√°s productos</button>
    </footer>
  }
</div>
@if (mensajeOk) {
  <div class="feedback-overlay success">
    <div class="feedback-content">
      <div class="icon">üöÄ</div>
      <h3>{{ mensajeOk }}</h3>
      <p>Estamos preparando todo...</p>
    </div>
  </div>
}

@if (mensajeError) {
  <div class="alert-error">
    <span>{{ mensajeError }}</span>
    <button (click)="mensajeError = ''">‚úï</button>
  </div>
}
